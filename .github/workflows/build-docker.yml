name: Docker Image Build CI for GHCR

on:
  workflow_dispatch: # Button to manually trigger update
  schedule:
    - cron: '0 4 * * *' # Check for updates every day at 4am UTC

env:
  REGISTRY: ghcr.io
  UPSTREAM_REPO: autobcb/read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout your repo
      uses: actions/checkout@v4

    - name: lowercase repository name
      run: echo "IMAGE_NAME=${GITHUB_REPOSITORY@L}" >> ${GITHUB_ENV}

    - name: Get Latest Release Version
      id: get_version
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Get the latest tag name from the upstream repo
        LATEST_TAG=$(gh release view --repo ${{ env.UPSTREAM_REPO }} --json tagName --jq .tagName)
        echo "Upstream version is: $LATEST_TAG"
        echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT

    - name: Download and Unzip Official Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Downloading assets from ${{ steps.get_version.outputs.version }}..."
        
        # Download the zip file from the remote repo to the current directory
        # We use a wildcard *.zip because the filename might change (e.g. read-0.0.1.zip)
        gh release download ${{ steps.get_version.outputs.version }} \
        --repo ${{ env.UPSTREAM_REPO }} \
        --pattern "web*.zip" \
        --dir ./downloads

        echo "Unzipping..."
        unzip ./downloads/web*.zip -d ./app

        if [ ! -f ./app/read.jar ]; then
        echo "Error: Could not find a .jar file in the downloaded release!"
        exit 1
        fi
        
        echo "JAR file prepared successfully."

    - name: Log in to the GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        # This generates two tags: 'latest' and the specific version (e.g., v1.2.3)
        tags: |
          type=raw,value=latest
          type=raw,value=${{ steps.get_version.outputs.version }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}